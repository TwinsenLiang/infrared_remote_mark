# 苹果A1294遥控器红外信号录制系统

一个专为苹果A1294遥控器设计的Web红外信号录制和分析系统，基于树莓派5和LIRC硬件，提供现代化的用户界面和完整的信号管理功能。

## 🌟 核心功能

- **🎯 精准信号录制**: 通过 `/dev/input/event1` 直接读取红外接收器信号
- **🔄 智能回弹键检测**: 自动识别按键释放信号，支持一键清除重新检测
- **🎨 深色模式支持**: 完整的深色主题，自动保存用户偏好
- **📱 完美响应式布局**: 适配手机、平板、桌面等各种设备
- **⚡ 实时信号反馈**: Toast通知和波纹动画效果
- **💾 配置管理**: 支持导入导出JSON格式的信号绑定配置
- **🔒 安全可靠**: 输入验证、内存优化、生产环境禁用DEBUG模式

## 🎮 支持的按键

系统支持以下7个按键的信号录制：

- **方向键**: 上（up）、下（down）、左（left）、右（right）
- **确认键**: 中央圆形区域（enter）
- **菜单键**: 左下角圆形按钮（menu）
- **播放/暂停键**: 右下角圆形按钮（play_pause）

## 🚀 快速开始

### 系统要求

- 树莓派5（或其他Linux设备）
- Python 3.7+
- 红外接收器（GPIO接入）
- LIRC配置

### 安装和运行

```bash
# 克隆或下载项目
cd /home/twinsenliang/Workspace/infrared_remote_mark

# 一键启动服务
./service.sh start

# 访问系统
# 浏览器打开: http://localhost:5000
# 或远程访问: http://<树莓派IP>:5000
```

### 服务管理

```bash
./service.sh start    # 启动服务
./service.sh status   # 查看状态
./service.sh stop     # 停止服务
./service.sh restart  # 重启服务
./service.sh logs     # 查看实时日志
./service.sh help     # 显示帮助信息
```

## 📖 使用说明

### 基本工作流程

1. **启动接收模式**
   - 点击"接收红外信号"按钮（绿色大按钮）
   - 系统开始监听红外接收器

2. **录制信号**
   - 按下遥控器按键
   - 系统接收两个信号：第一个是按键信号，第二个是回弹键
   - 第二个信号会被自动标记为回弹键（绿色显示）

3. **绑定按键**
   - 点击SVG遥控器上对应的按钮位置
   - 系统自动绑定第一个信号（可绑定信号）
   - 回弹键信号不能被绑定

4. **解绑按键**
   - 再次点击已绑定的按钮
   - 确认解绑操作

5. **导出配置**
   - 点击"导出绑定"按钮
   - 下载JSON格式的配置文件

### 智能回弹键检测

系统会自动检测回弹键：
- 当两个不同信号在300ms内快速连续到达时
- 第二个信号被自动识别为回弹键
- 回弹键信号在调试信息中显示为绿色
- 回弹键统计区域显示具体的信号值
- 可点击 × 按钮清除回弹键设置，重新检测

### 深色主题

- 点击右上角月亮图标切换深色/浅色主题
- 主题偏好自动保存到浏览器本地存储
- 首次访问时根据系统偏好自动适配

## 🛠️ 系统架构

```
infrared_remote_mark/
├── app.py                     # Flask主应用
├── infrared_receiver.py       # 红外接收器模块（硬件集成）
├── service.sh                 # 统一服务管理脚本
├── templates/
│   └── index.html            # 主界面（深色主题、回弹键检测）
├── A1294.svg                  # 苹果A1294遥控器SVG图形
├── signal_bindings.json       # 信号绑定数据（自动生成）
├── requirements.txt           # Python依赖包
├── logs/
│   └── app.log               # 服务运行日志
└── README.md                 # 项目说明文档
```

## 📊 技术栈

### 后端技术
- **Flask**: Web框架
- **Python struct**: 解析Linux input event
- **Python select**: 非阻塞I/O
- **XML ElementTree**: SVG解析

### 前端技术
- **Tailwind CSS 3**: 现代化CSS框架
- **Font Awesome 6**: 图标库
- **Vanilla JavaScript**: 原生JavaScript（ES6+）
- **localStorage API**: 主题偏好存储

### 硬件集成
- **Linux Input Subsystem**: 通过 `/dev/input/event1` 读取红外信号
- **LIRC**: 红外接收器驱动
- **GPIO**: 树莓派GPIO口连接红外接收器

## 🔌 硬件配置

### 红外接收器设置

确保红外接收器设备文件存在：
```bash
# 检查设备
ls -l /dev/input/event*

# 确认权限
sudo chmod 666 /dev/input/event1

# 测试接收（可选）
sudo evtest /dev/input/event1
```

### 信号格式

系统接收的信号格式为32位十六进制值：
```
0x87EE260C  # 示例信号值
```

## 🎨 界面特性

### 视觉效果
- **玻璃拟态设计**: 现代化的毛玻璃背景效果
- **渐变色彩**: 紫色到粉色的渐变卡片
- **波纹动画**: 按键点击和信号接收的视觉反馈
- **平滑过渡**: 300ms的CSS过渡动画

### 交互反馈
- **Toast通知**: 成功/失败/警告/信息提示
- **颜色编码**:
  - 蓝色：普通信号
  - 绿色：回弹键信号、已绑定状态
  - 橙色：测试信号（已移除）
  - 红色：错误提示

### 响应式布局
- **移动端**: 单列布局，触摸优化
- **平板端**: 自适应布局
- **桌面端**: 左右分栏，完整功能

## 🔧 配置说明

### 环境变量

```bash
# Flask调试模式（生产环境不要开启）
export FLASK_DEBUG=False

# 服务端口
export FLASK_PORT=5000
```

### 信号绑定文件格式

```json
{
  "bindings": {
    "up": {
      "signal": "0x87EE260A",
      "timestamp": 1764309828.6494155
    },
    "down": {
      "signal": "0x87EE260C",
      "timestamp": 1764309812.7542112
    }
  },
  "releaseKey": "0x87EE2605"
}
```

## 🐛 故障排除

### 常见问题

**1. 服务启动失败**
```bash
# 检查Python版本
python3 --version

# 检查端口占用
sudo netstat -tlnp | grep 5000

# 查看详细日志
./service.sh logs
```

**2. 无法接收红外信号**
```bash
# 检查设备文件
ls -l /dev/input/event1

# 检查权限
sudo chmod 666 /dev/input/event1

# 测试设备
sudo evtest /dev/input/event1
```

**3. 界面显示异常**
- 清理浏览器缓存
- 检查网络连接（Tailwind CSS CDN）
- 使用无痕模式测试

**4. 回弹键检测不准确**
- 点击回弹键区域的 × 按钮清除设置
- 重新按下遥控器按键让系统重新检测
- 检查300ms阈值是否合适（可在代码中调整）

### 日志查看

```bash
# 实时查看日志
./service.sh logs

# 查看历史日志
cat logs/app.log

# 过滤错误日志
grep "error" logs/app.log -i
```

## 📝 版本历史

### v1.0.0 (2025-11-28)

**核心功能**
- ✨ 基于硬件的红外信号录制
- 🔄 智能回弹键自动检测
- 🎨 深色主题支持
- 💾 信号绑定导入导出
- ⚡ 实时波纹动画反馈

**技术优化**
- 🔒 输入验证和安全加固
- 📊 内存优化（限制信号历史1000条）
- 🚫 移除未使用的依赖
- ⚙️ 环境变量配置支持
- 🐛 移除测试模拟按钮

**界面改进**
- 🌙 完整的深色主题适配
- 📱 响应式布局优化
- 🎯 回弹键信号值显示
- ✨ 波纹效果优化

## 🗺️ 未来规划

### v2.0.0 计划功能
- [ ] 支持多个遥控器配置管理
- [ ] 增加其他红外遥控器设备录制支持
- [ ] WebSocket实时推送替代长轮询
- [ ] 信号分析和统计图表
- [ ] 批量导入导出多个遥控器配置
- [ ] 用户认证和权限管理
- [ ] Docker容器化部署

### v2.1.0 计划功能
- [ ] 红外信号发送功能（需要发射器硬件）
- [ ] 宏录制功能（一键发送多个信号）
- [ ] 定时任务（定时发送信号）
- [ ] 移动端原生应用

## 🔒 安全说明

### 已实施的安全措施
- ✅ 所有POST端点的输入验证
- ✅ 信号格式验证（正则表达式）
- ✅ 按键名称白名单验证
- ✅ 生产环境禁用DEBUG模式
- ✅ 限制信号历史防止内存溢出
- ✅ 最小化依赖，移除未使用包

### 建议的额外措施（可选）
- 添加CSRF保护（Flask-WTF）
- 实现API速率限制（Flask-Limiter）
- 使用HTTPS加密传输
- 添加用户认证
- 实现审计日志

## 📄 许可证

本项目基于 MIT 许可证开源，仅供学习和个人使用。

## 🤝 贡献指南

欢迎提交Issue和Pull Request！

在提交PR前请确保：
- 代码通过所有测试
- 遵循现有的代码风格
- 更新相关文档

## 💡 致谢

- Tailwind CSS团队 - 现代化CSS框架
- Font Awesome团队 - 图标库
- LIRC项目 - 红外接收支持

---

**快速开始**:
```bash
./service.sh start
```
然后访问 http://localhost:5000 或 http://192.168.50.129:5000
